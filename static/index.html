<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFProc v.2 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        .drop-zone--over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body class="min-h-screen text-slate-800">

    <nav class="bg-white border-b border-slate-200 py-4">
        <div class="max-w-6xl mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i class="fas fa-file-invoice text-white text-xl"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900">PDFProc <span
                        class="text-blue-600">v.2</span></h1>
            </div>
            <div id="connection-status" class="flex items-center space-x-2 text-sm text-slate-500">
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                <span>API Online</span>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Left Column: Upload -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <h2 class="text-lg font-semibold mb-4">Upload Invoices</h2>
                <div id="drop-zone"
                    class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-blue-400">
                    <input type="file" id="file-input" class="hidden" accept=".pdf">
                    <i class="fas fa-cloud-upload-alt text-4xl text-slate-300 mb-3"></i>
                    <p class="text-sm text-slate-600 mb-1 font-medium">Click to upload or drag & drop</p>
                    <p class="text-xs text-slate-400">Support PDF files only (Max 10MB)</p>
                </div>

                <div id="upload-progress" class="hidden mt-6 space-y-3">
                    <div class="flex justify-between text-sm">
                        <span id="upload-filename" class="truncate max-w-[150px] font-medium">filename.pdf</span>
                        <span id="upload-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="bg-blue-600 p-6 rounded-2xl text-white shadow-lg shadow-blue-100">
                <h3 class="font-bold mb-2">Cascade Workflow</h3>
                <p class="text-sm text-blue-100 leading-relaxed">
                    V2 automatically attempts to process text first (Tier 1). If confidence is low, it falls back to
                    Vision models (Tier 2).
                </p>
            </div>
        </div>

        <!-- Right Column: Recent Activity -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Recent Processing Jobs</h2>
                    <button id="refresh-btn" class="text-slate-400 hover:text-blue-600 transition-colors">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider">
                            <tr>
                                <th class="px-6 py-3 font-semibold">Job ID</th>
                                <th class="px-6 py-3 font-semibold">Filename</th>
                                <th class="px-6 py-3 font-semibold">Status</th>
                                <th class="px-6 py-3 font-semibold text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table-body" class="divide-y divide-slate-100">
                            <!-- Rows injected by JS -->
                            <tr>
                                <td colspan="4" class="px-6 py-12 text-center text-slate-400 italic">
                                    No recent jobs found. Upload a file to start.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Results Modal -->
    <div id="modal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white">
                <h2 class="text-lg font-bold">Extraction Results</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <div id="modal-content" class="p-6 space-y-4 text-sm">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const jobsBody = document.getElementById('jobs-table-body');
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const uploadPercent = document.getElementById('upload-percent');
        const uploadFilename = document.getElementById('upload-filename');

        // Initial Load
        fetchJobs();
        setInterval(fetchJobs, 5000); // Polling every 5 seconds

        // Event Listeners
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleUpload(e.target.files[0]);
        document.getElementById('refresh-btn').onclick = fetchJobs;

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drop-zone--over');
        });

        ['dragleave', 'dragend'].forEach(type => {
            dropZone.addEventListener(type, () => {
                dropZone.classList.remove('drop-zone--over');
            });
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone--over');
            if (e.dataTransfer.files.length) {
                handleUpload(e.dataTransfer.files[0]);
            }
        });

        async function handleUpload(file) {
            if (!file || !file.name.toLowerCase().endsWith('.pdf')) {
                alert('Please upload a valid PDF file.');
                return;
            }

            uploadFilename.textContent = file.name;
            uploadProgress.classList.remove('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload/', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    progressBar.style.width = '100%';
                    uploadPercent.textContent = '100%';
                    setTimeout(() => {
                        uploadProgress.classList.add('hidden');
                        progressBar.style.width = '0%';
                        fetchJobs();
                    }, 1000);
                } else {
                    const err = await response.json();
                    alert(`Upload failed: ${err.detail || 'Unknown error'}`);
                    uploadProgress.classList.add('hidden');
                }
            } catch (err) {
                console.error(err);
                alert('Upload failed. Check console.');
                uploadProgress.classList.add('hidden');
            }
        }

        async function fetchJobs() {
            try {
                const response = await fetch('/jobs/');
                const jobs = await response.json();
                renderJobs(jobs);
            } catch (err) {
                console.error("Failed to fetch jobs:", err);
            }
        }

        function renderJobs(jobs) {
            if (!jobs.length) return;

            jobsBody.innerHTML = jobs.map(job => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 font-mono text-xs text-slate-500">#${job.id}</td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-slate-900 truncate max-w-[200px]">${job.filename}</div>
                        <div class="text-[10px] text-slate-400">${new Date(job.created_at).toLocaleString()}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-1 rounded-full text-[11px] font-bold uppercase status-${job.status}">
                            ${job.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        ${job.status === 'completed' ? `
                            <button onclick="viewJob(${job.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                <i class="fas fa-eye mr-1"></i> View
                            </button>
                        ` : job.status === 'failed' ? `
                            <button onclick="viewJob(${job.id})" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                <i class="fas fa-exclamation-triangle mr-1"></i> Error
                            </button>
                        ` : `
                            <i class="fas fa-circle-notch fa-spin text-slate-300"></i>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        async function viewJob(id) {
            try {
                const response = await fetch(`/jobs/${id}`);
                const data = await response.json();

                let contentHtml = '';

                if (data.status === 'completed' && data.invoices.length) {
                    const inv = data.invoices[0];
                    contentHtml = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h3 class="font-bold text-slate-900 mb-4 flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i> Standardized Data
                            </h3>
                            <div class="grid grid-cols-2 gap-y-4">
                                <div class="text-slate-500">Company Name</div>
                                <div class="font-semibold">${inv.company_name}</div>
                                <div class="text-slate-500">PO Number</div>
                                <div class="font-mono bg-white px-2 py-0.5 border border-slate-200 rounded w-fit">${inv.po_number}</div>
                                <div class="text-slate-500">Invoice Number</div>
                                <div class="font-mono bg-white px-2 py-0.5 border border-slate-200 rounded w-fit">${inv.invoice_number}</div>
                                <div class="text-slate-500">Processing Tier</div>
                                <div>
                                    <span class="px-2 py-0.5 rounded-md text-[10px] font-bold uppercase ${inv.tier_used === 'vision_fallback' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                        ${inv.tier_used}
                                    </span>
                                </div>
                                <div class="text-slate-500">Confidence</div>
                                <div class="font-medium">${(inv.confidence_score * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-semibold mb-2">Saved As:</h4>
                            <p class="text-xs font-mono text-slate-600 bg-slate-100 p-2 rounded">${inv.original_split_path.split('/').pop()}</p>
                        </div>
                    `;
                } else if (data.status === 'failed') {
                    contentHtml = `
                        <div class="bg-red-50 p-4 rounded-xl border border-red-100 text-red-800">
                            <h3 class="font-bold mb-2">Processing Error</h3>
                            <p class="font-mono text-xs">${data.error || 'Unknown server error during processing.'}</p>
                        </div>
                    `;
                }

                document.getElementById('modal-content').innerHTML = contentHtml;
                document.getElementById('modal').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                alert("Could not load job details.");
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // Close modal on backdrop click
        document.getElementById('modal').onclick = (e) => {
            if (e.target.id === 'modal') closeModal();
        };
    </script>
</body>

</html>